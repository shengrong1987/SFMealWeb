<%- include ../email_header %>

<div class="green" style="padding: 25px;">
  <div class="box-email white relative middle text-left">
    <h4 class="text-green"><%= orders.length == 0 ? guestlistnotitle : guestlisttitle%></h4>
    <p>Hi <%= recipientName%>,</p>

    <%
    var orderSummary = {};
    orders.forEach(function(order){
      Object.keys(order.orders).forEach(function(dishId){
        var dish = order.dishes.filter(function(d){
          return d.id === dishId;
        })[0];
        if(!dish){
          return;
        }
        var orderDetail = order.orders[dishId];
        if(orderSummary.hasOwnProperty(dishId)){
          if(order.orders[dishId].number){
            orderSummary[dishId].amount += orderDetail.number;
            orderDetail.preference.forEach(function(prefs){
              prefs.property.forEach(function(prop){
                if(orderSummary[dishId].preference){
                  orderSummary[dishId].preference += ",";
                }
                if(prop.property && prop.property !== "undefined"){
                  orderSummary[dishId].preference += prop.property;
                }
              })
            })
          }
        }else if(order.orders[dishId].number){
          var dishObj = {};
          dishObj.title = dish.title;
          dishObj.amount = orderDetail.number;
          dishObj.price = orderDetail.price;
          dishObj.preference = "";
          orderDetail.preference.forEach(function(prefs){
            prefs.property.forEach(function(prop){
              if(dishObj.preference){
                dishObj.preference += ",";
              }
              if(prop.property && prop.property !== "undefined"){
                dishObj.preference += prop.property;
              }
            })
          })
          orderSummary[dishId] = dishObj;
        }
      })
    })
      var orderSummaryKey = Object.keys(orderSummary);
    %>
    <p><%= orderSummaryKey.length == 0 ? guestlistnocontext : guestlistcontext%></p>

    <% if(orderSummaryKey.length){ %>
      <table class="table table-email">
        <thead>
        <tr>
          <td><%= title%></td>
          <td><%= price%></td>
          <td><%= quantity%></td>
          <td><%= comment%></td>
        </tr>
        </thead>
        <tbody>
        <% orderSummaryKey.forEach(function(dishId){ var dishObj = orderSummary[dishId]; %>
          <tr>
            <td><%= dishObj.title %></td>
            <td><%= dishObj.price%></td>
            <td><%= dishObj.amount%></td>
            <td><%= dishObj.preference%></td>
          </tr>
        <% })%>
        </tbody>
      </table>
    <% };%>

    <div class="divider"></div>

    <div class="row text-center">
      <% if(orderSummaryKey.length == 0){%>
        <a class="btn btn-outline-primary" style="border:1px solid #007bff;" href="http://www.sfmeal.com/meal/<%= id%>?edit=true"><%= openmeal%></a>
      <%}else{%>
        <a class="btn btn-outline-primary" style="border:1px solid #007bff;" href="http://www.sfmeal.com/meal/<%= id%>/report"><%= printlist%></a>
      <%}%>

    </div>
  </div>

</div>

<%- include ../email_footer %>
