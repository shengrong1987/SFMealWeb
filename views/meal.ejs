<div class="container default-container text-center relative" style="margin-top:-20px;background-color: #f2f2f2;">

  <div class="compact-banner">
    <div class="img-wrapper row">
      <img src="/images/homecover-1.jpg" class="relative middle">
    </div>

    <div class="absolute logo-container">

      <div class="col-lg-3 col-sm-4 col-xs-12 relative text-left">
        <a href="/" class="logo"></a>
      </div>

      <div class="relative text-left col-lg-9 col-sm-8 col-xs-12 content">
        <h4 class="text-white"><strong><%__('searching-word')%></strong></h4>
        <div class="btn-group">
          <input class="input btn btn-default round light text-grey" placeholder="<%= __('searching-tips')%>">
          <button class="btn btn-warning round orange text-white" onclick="javascript:search(this)">
            <i class="fa fa-search"></i>
            <%= __('search')%>
          </button>
        </div>
        <button class="btn btn-red round" onclick="location.href='/meal'"><%= __('see-menu')%></button>
      </div>
    </div>
  </div>

  <div id="shoppingCartView" class="btn btn-red btn-info vertical-align" style="position: fixed;bottom: 0;right: 0;z-index:90;width: 100%;height:50px;" onclick="javascript:location.href='#order'">
    <div style="width:100%;height: 35px;line-height: 35px;">
      <div class="col-xs-3"><span style="left: 10px;" class="total-preview relative" data-subtotal=""></span></div>
      <div class="col-xs-6 middle"><span style="margin-right: 5px;text-align: center;"><%= __('check-out-fast-btn')%></span></div>
      <div class="col-xs-3 text-right"><div style="right: 10px;" class="btn btn-outline-white order-preview relative" data-item=""></div></div>
    </div>

  </div>

  <div id="meal-detail-container" class="padding-clear" data-meal-prepareTime="<%= meal.prepareTime%>" data-user-lat="<%= user?user.lat:''%>" data-user-long="<%= user?user.long:''%>" data-range="<%= meal.delivery_range%>" data-title="<%= meal.title%>" data-coverString="<%= meal.coverString%>" data-cover="<%= meal.cover%>">

    <div class="row">
      <div class="col-md-8">
        <div class="box white">
          <div class="row">
            <div class="col-xs-12 col-sm-6">
              <div class="row">
                <div class="col-xs-9">
                  <h2 class="text-left"><%= meal.title %>  <small class="text-orange"><% if(meal.type=='order'){ __('order') }else if(meal.type=='preorder'){ __('preorder') } %> <i class="fa fa-question-circle text-lightgrey"></i><%= meal.isFull()? __('full'): "" %></small></h2>
                </div>
                <div class="col-xs-3" style="margin-top: 20px;">
                  <i class="fa fa-heart-o round_thumb border-red text-red fa-2x cursor-pointer" style="padding:8px;" data-select="<% if(user && user.collects){%><%= user.isCollect(meal.id)%><%}else{%>false<%}%>" data-toggle="collect-item" data-meal="<%= meal.id%>" data-user="<%= user?user.id:user%>" data-heart="true"></i>
                </div>
              </div>

              <div class="row vertical-align-base">
                <div class="col-xs-12 text-left">
                  <div data-toggle="tooltip" data-placement="bottom" title="<%= meal.score.toFixed(2)%>" style="display: inline;margin-top: 5px;">
                    <div class="rating" data-toggle="star-set" data-rate="<%= meal.score.toFixed(2)%>">
                      <i class="fa fa-star"></i>
                      <i class="fa fa-star"></i>
                      <i class="fa fa-star"></i>
                      <i class="fa fa-star"></i>
                      <i class="fa fa-star"></i>
                    </div>
                  </div>
                  <small style="font-size: 20px;" class="text-lightgrey">(<%= meal.numberOfReviews %>)</small>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-12">
                  <% if(meal.type=="order"){%>
                    <h3 class="text-left"><small><%= __('provide-time')%> <span data-toggle="time-span" data-format="hourly" data-from="<%= meal.provideFromTime%>" data-to="<%= meal.provideTillTime%>" class="text-red"> <%= meal.provideDate()%></span></small></h3>
                  <%}else{%>
                    <h3 class="text-left"><small><%= __('book-time')%> <span data-toggle="time-span" data-format="date" data-from="<%= meal.provideFromTime%>" data-to="<%= meal.provideTillTime%>" class="text-red"> <%= meal.provideDate()%></span></small></h3>
                    <h3 class="text-left"><small><%= __('pickup-time')%> <span data-toggle="time-span" data-format="day" data-date="<%= meal.pickups[0].pickupFromTime%>" class="text-red"></span></small></h3>
                  <%}%>
                </div>
              </div>

              <div class="row chef-cell vertical-align text-center">
                <div class="col-md-2 col-xs-3">
                  <img class="round_thumb size-small text-center cursor-pointer" onclick="javascript:location.href='/host/<%= meal.chef.id%>'" src=<%= meal.chef.picture || "/images/profile_man.png" %>>
                  <br/>
                  <i class="fa fa-question-circle fa-2x text-lightgrey cursor-pointer" title="<%= __('')%>"></i>
                </div>
                <div class="col-md-10 col-xs-8">
                  <h4 class="text-left text-dark text-box" style="margin: 0 0 10px 10px;"><%= meal.chef.shopName %><br><small><%= meal.chef.intro %></small></h4>
                </div>
              </div>

              <div class="row">
                <% if(meal.type === "order"){%>
                  <div class="box-simple text-left">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox">
                        <small class="font-small">
                          <span class="text-black"><%= __('kitchen-pickup')%></span><br/>
                          <%= __('ready-time')%>: <%= meal.prepareTime%><%= __('min')%><br/>
                          <%= __('pickup-time')%>:<a class="calculateBtn" class="text-red" data-method="pickup" data-location="<%= meal.chef.full_address%>" href="javascript:void(0)"><%= __('click-to-cal')%></a>
                        </small><br/>
                      </label>
                    </div>
                  </div>
                  <% if(meal.isDelivery){%>
                  <div class="box-simple text-left">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox">
                        <small class="font-small">
                          <span class="text-black"><%= __('delivery')%></span>
                          <%= __('delivery-fee')%>:$<%= meal.delivery_fee%><br/>
                          <%= __('delivery-time')%>:<a class="calculateBtn" class="text-red" data-location="<%= meal.chef.full_address%>" href="javascript:void(0)"><%= __('click-to-cal')%></a><label></label><br/>
                          <%= __('ready-time')%>: <%= meal.prepareTime%><%= __('min')%>
                        </small>
                      </label>
                    </div>
                  </div>
                  <%}%>
                  <div id="addressAlertView" class="alert alert-danger hide"><%= __('delivery-out-of-range-error')%></div>
                <%}else{
                var count = 1;
                meal.pickups.forEach(function(pickup){ if(pickup.method == "pickup"){%>
                  <div class="box-simple text-left pickup" data-location="<%= pickup.publicLocation%>" data-name="<%= __('location') + count%>">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox">
                        <small class="font-small">
                          <b><%= __('location') + count %>:</b>
                          <% if( orders && orders.some(function(order){ if(!user){return false}; return order.customer == user.id}) || (user && user.host == meal.chef.id)){%>
                            <span data-point="<%= pickup.location%>"><%= pickup.location || ''%></span>
                          <%}else if(pickup.method == "pickup"){%>
                            <span data-point="<%= pickup.publicLocation || pickup.location %>"><%= pickup.publicLocation ? (pickup.publicLocation + ' ' + __('pickup-location-after-order')): pickup.location %></span>
                          <%}%>
                          <br/><br/>
                          <% if(pickup.instruction){%>
                          <b><%= __('pickup-instruction')%>: <%= pickup.instruction || ''%></b><br/>
                          <%}%>
                          <b><%= __('time')%></b> <span data-toggle="time-span" data-format="date" data-from="<%= pickup.pickupFromTime%>" data-to="<%= pickup.pickupTillTime%>"></span>
                          <br/><br/>
                          <%= __('pickup-time')%>:<a class="text-red calculateBtn" data-location="<%= pickup.location%>" href="javascript:void(0)"><%= __('click-to-cal')%></a><label></label>
                          <br/>
                          <b><%= __('pickup-method')%>: <%= __('self-pickup') %></b>
                        </small>
                      </label>
                    </div>
                  </div>
                <% }else{%>

                <div class="box-simple text-left deliveryOption" data-location="<%= pickup.deliveryCenter%>">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox">
                      <small class="font-small">
                        <b><%= __('location') + count %>:</b>
                        <span class="text-black"><%= __('delivery')%></span>
                        <%= __('delivery-fee')%>:$<%= meal.delivery_fee%><br/>
                        <%= __('delivery-time')%>:<a class="calculateBtn" class="text-red" data-location="<%= meal.chef.full_address%>" href="javascript:void(0)"><%= __('click-to-cal')%></a><label></label><br/>
                        <span class="time" data-from="<%= pickup.pickupFromTime%>" data-to="<%= pickup.pickupTillTime%>"><%= __('pickup-time') %><span data-toggle="time-span" data-format="date" data-from="<%= pickup.pickupFromTime%>" data-to="<%= pickup.pickupTillTime%>" style="margin-left: 10px;"></span></span>
                      </small>
                    </label>
                  </div>
                </div>

                <%}count++;});}%>
                <%if(meal.isShipping){%>
                <div class="box-simple text-left">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox">
                      <small class="font-small">
                        <%= __('shipping')%> <%= __('free-shipping-policy', meal.shippingPolicy ? meal.shippingPolicy.freeAmount : '')%>
                      </small>
                    </label>
                  </div>
                </div>
                <%}%>
              </div>
            </div>

            <div class="col-xs-12 col-sm-6">
              <div class="vertical-align">
                <h4><small><%= __('share-to-all')%></small></h4>
                <div id="social-share"></div>
                <script>
                  $("#social-share").jsSocials({
                    shareIn: "popup",
                    text : "SFMeal.com",
                    shares: ["facebook", "pinterest","twitter","pocket"]
                  });
                </script>
              </div>

              <h4 class="text-left"><small><% __('pickup-location-after-order')%></small></h4>

              <div id="googlemap" style="min-height: 550px;"></div>
            </div>
          </div>

          <%
            var dishes = meal.dishes;
            var typeName = {"appetizer" : __('appetizer'), "entree" : __('main'), "dessert" : __('dessert')};
            var header = {"appetizer" : false, "entree" : false, "dessert" : false};
            for(var i=0; i < dishes.length; i++){
              var dish = dishes[i];
              if(!header[dish.type]){
                header[dish.type] = true;
          %>

          <div class="dark category-cell">
            <h4 class="text-white"><%= typeName[dish.type] %></h4>
          </div>

          <% }%>

          <h2></h2>

          <div class="row">
            <div class="col-xs-12">
              <div class="round-container dish" data-id=<%= dish.id %>>
                <% dish.photos.forEach(function(photo, index){if(photo.v){%>
                <a href="<%= photo.v %>" data-toggle="lightbox" data-title="<%= dish.title%>" data-footer="<%= dish.description%>" data-gallery="<%= dish.id%>" data-type="image" style="display: <%= index==0?'block':'none'%>">
                  <img src="<%= index==0?photo.v:''%>" style="width:100%;" class="<%= index!=0?'lazyload':''%>" data-src=<%= photo.v%>>
                </a>
                <%}});%>
                <% if(dish.video){%>
                <a href="<%= dish.video%>" data-toggle="lightbox" data-title="<%= dish.title%>" data-footer="<%= dish.description%>" data-type="instagram" class="absolute" style="position: absolute; top:10px; left: 20px;">
                  <i class="fa fa-play fa-2x text-red"></i>
                </a>
                <%}%>
                <div class="box-float-top-right red"><h3 class="text-white" style="margin-top: 10px;">$<%= dish.price.toFixed(2) %></h3></div>
                <div class="row dish-operator">
                  <div class="col-sm-8">
                    <div>
                      <div class="col-sm-3">
                        <h4 class="text-black"><%= dish.title %><span> ( <%= dish.quantity || '1' + __('fen') %> )</span></h4>
                      </div>
                      <div class="col-sm-6">
                        <div data-toggle="tooltip" data-placement="bottom" title="<%= dish.score.toFixed(2)%>" style="display: inline;margin-top: 5px;">
                          <div class="rating" data-toggle="star-set" data-rate="<%= dish.score.toFixed(2)%>">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                          </div>
                        </div>
                        <small style="font-size: 20px;" class="text-lightgrey">(<%= dish.numberOfReviews %>)</small>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-sm-12">
                        <h3 style="padding: 5px;" class="none-margin"><small><%= dish.description %></small></h3>
                      </div>
                    </div>
                  </div>

                  <div class="col-sm-4">

                    <div class="row">
                      <div class="col-xs-12">
                        <h4><small class="left-amount"><%= __('left')%><span class="text-red" value=<%= meal.leftQty[dish.id] %>><%= meal.leftQty[dish.id] %></span><%= __('fen')%></small></h4>
                      </div>
                    </div>

                    <div class="row beforeOrder">
                      <div class="col-xs-12">
                        <button class="btn btn-red take-order btn-lg <%= parseInt(meal.leftQty[dish.id])==0 ? 'disabled' : '' %>" onclick="javascript:orderFood('<%= dish.id %>',1, true)"><%= parseInt(meal.leftQty[dish.id]) == 0 ? __('check-out-sold-btn') : __('order-one')%></button>
                      </div>
                    </div>

                    <div class="row afterOrder">
                      <div class="col-xs-12" style="margin-top:10px;">
                        <div class="input-group input-group-lg amount-input round" data-toggle="amount-input" data-max="<%= meal.leftQty[dish.id] %>" data-dish="<%= dish.id%>" style="width:150px;margin:auto;">
                          <div class="input-group-addon minus" onclick="javascript:orderFood('<%= dish.id %>',-1)">-</div>
                          <input class="form-control text-center dish-number" type="number" pattern="[0-9]*" inputmode="numeric" value="0" style="min-width: 75px;">
                          <div class="input-group-addon add" onclick="javascript:orderFood('<%= dish.id %>',1)">+</div>
                        </div>
                      </div>
                    </div>

                    <div class="row afterOrder" style="margin-top: 10px;">
                      <% if(dish.preference && Object.keys(dish.preference).length){%>
                      <div class="col-xs-12">
                        <a class="btn btn-default btn-outline dropdown-toggle" data-dish=<%= dish.id%> style="width:160px;" type="button" data-toggle="dropdown" data-layer="0" data-submenu aria-haspopup="true" aria-expanded="true" value="">
                          <span><%= __('addVariation')%></span>
                          <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu text-center" aria-labelledby="dLabel">
                          <li class="dropdown-submenu" data-layer="0">
                            <a tabindex="0" data-toggle="dropdown" data-selected="true"><%= __('the')%>1<%= __('fen')%></a>
                            <ul class="dropdown-menu">
                              <% Object.keys(dish.preference).forEach(function(key){%>
                              <li class="dropdown-submenu variation" data-layer="1">
                                <a tabindex="0" data-toggle="dropdown" data-dish=<%= dish.id%> data-variation=<%= key%> data-selected="true"><%= __(key)%></a>
                                <ul class="dropdown-menu">
                                  <% var options = dish.preference[key]; options.forEach(function(option){%>
                                  <li tabindex="0"><a value="<%= option.property%>" data-extra="<%= option.extra%>" href="javascript:void(0);"><%= option.property%> + $<%= option.extra%></a></li>
                                  <%});%>
                                </ul>
                              </li>
                              <%});%>
                            </ul>
                          </li>
                        </ul>
                      </div>
                      <% } %>
                    </div>

                  </div>
                </div>

                <h1></h1>
              </div>
              <h1></h1>

              <h1></h1>

              <ul class="nav nav-tabs" data-toggle="tabs">
                <li class="active"><a href="#review<%= i%>" data-toggle="tab" class="text-red"><%= __('user-review')%></a></li>
                <li><a href="#host<%= i%>" data-toggle="tab" class="text-red"><%= __('host-review')%></a></li>
              </ul>

              <div class="tab-content">
                <div id="review<%= i%>" class="tab-pane active">
                  <%
                    var reviews = meal.reviews;
                    var number = 0;
                    var perPage = 3;
                    var curPage = 1;
                    for(var j=0; j < reviews.length; j++){
                      var review = reviews[j];
                      if(review.dish == dish.id && review.isPublic){
                        number++;
                  %>
                  <div class="item">
                    <div class="row">
                      <div class="col-sm-9 text-left">
                        <div data-toggle="tooltip" data-placement="bottom" title="<%= review.score.toFixed(2)%>" style="margin-top: 5px;display: inline;">
                          <div class="rating" data-toggle="star-set" data-rate="<%= review.score.toFixed(2)%>">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                          </div>
                        </div>
                        <h4 style="display: inline-block;"><small style="font-size: 16px;" class="text-grey" data-id=<%= review.user %>><%= review.username %> : <%= review.title%> ( $<%= parseFloat(review.price).toFixed(2)%> )</small></h4>
                      </div>
                      <div class="col-sm-3">
                        <h3 class="text-right"><small><%= review.get_formatted_time() %></small></h3>
                      </div>
                    </div>
                    <h4 class="text-left"><small class="text-black"><%= review.review %></small></h4>
                    <div class="divider"></div>
                  </div>
                  <% }} %>

                  <nav class="pull-right">
                    <ul class="pagination pagination-sm" data-trigger="pagination" data-target="#review<%= i%>" data-npp="3">
                      <li class="active"><a href="javascript:void(0)">1</a></li>
                    </ul>
                  </nav>
                </div>

                <div id="host<%= i%>" class="tab-pane">
                </div>
              </div>

            </div>
          </div>
          <%} %>

      <h1></h1>
      </div>
    </div>

      <div class="col-md-4">
        <div class="box white floater static-floater">
          <div id="order-alert" class="alert alert-danger hide" role="alert">
            <%= __('dish-out-tips')%>
          </div>
          <% if(meal.isFull()){%>
          <div class="alert alert-danger" role="alert">
            <%= __('dish-out-tips')%>
          </div>
          <%}%>
          <table id="order" class="table tableBodyScroll" data-err-container="#order-alert">
            <thead>
            <tr>
              <th><%= __('name')%></th>
              <td><%= __('price')%></td>
              <td><%= __('quantity')%></td>
            </tr>
            </thead>
            <tbody class="scroll">
            <%
              var dishes = meal.dishes;
              for(var i=0; i < dishes.length; i++){
                var dish = dishes[i];
            %>
            <tr class="success item" data-id=<%= dish.id %> data-left-amount=<%= meal.leftQty[dish.id] %>>
              <td><%= dish.title %><br/><span class="preference"></span> </td>
              <td class="price" value=<%= dish.price %> data-extra=0>$<%= dish.price %></td>
              <td>
                <button type="button" class="btn btn-default btn-xs" onclick="javascript:orderFood('<%= dish.id %>',-1,true)">-</button>
                <span class="amount" style="padding: 5px;">  0  </span>
                <button type="button" class="btn btn-default btn-xs" onclick="javascript:orderFood('<%= dish.id %>',1,true)">+</button>
              </td>
            </tr>
            <% }%>
            </tbody>
            <tbody>
            <tr></tr>
            <tr>
              <th></th>
              <td></td>
              <th class="text-right"><%= __('meal-fee')%><span class="subtotal">$0.00</span></th>
            </tr>
            <tr class="border-less">
              <th></th>
              <td></td>
              <th class="text-right"><%= __('tax')%>:<span class="tax" data-value="0" data-taxrate="<%= meal.getTaxRate()%>"> $0.00</span></th>
            </tr>
            <tr>
            <th></th>
            <td></td>
            <th class="text-right"><i class="fa fa-question-circle text-lightgrey cursor-pointer" data-toggle="tooltip" title="<%= __('tip-service-fee')%>"></i> <%= __('service-fee')%>:<span class="service-fee" data-value="0"> $1.00</span></th>
            </tr>
            <tr></tr>
            <tr>
              <th style="vertical-align: middle;"><i class="fa fa-question-circle text-lightgrey cursor-pointer" data-toggle="tooltip" title="<%= __('coupon')%>"></i> <%= __('coupon')%>:</th>
              <th><input class="coupon-code form-control" style="margin:0 5px 0 5px;width: 80px;" maxlength="7" data-code="" data-value=""></input></th>
              <th class="text-right">
                <button id="applyCouponBtn" class="btn btn-green"><%= __('apply-code')%></button>
                <button id="disApplyCouponBtn" class="btn btn-default btn-outline" onclick="javascript:applyCoupon(false);"><%= __('disapply-code')%></button>
              </th>
            </tr>
            <tr>
              <th style="vertical-align: middle;"><i class="fa fa-question-circle text-lightgrey cursor-pointer" data-toggle="tooltip" title="<%= __('points-tips')%>"></i> <%= __('points')%>:</th>
              <th><input class="points form-control" style="margin:0 5px 0 5px;width: 80px;" readonly value="<%= user?(user.points || 0):-1%>"></input></th>
              <th class="text-right">
                <button id="applyPointsBtn" class="btn btn-green"><%= __('apply-code')%></button>
                <button id="disApplyPointsBtn" class="btn btn-default btn-outline" onclick="javascript:applyPoints(false);"><%= __('disapply-code')%></button>
              </th>
            </tr>
            <tr></tr>
            <tr>
              <th class="text-right"><%= __('total')%><span class="total"></span></th>
            </tr>
            </tbody>
          </table>

          <button type="button" data-id="<%= meal.id%>" class="btn btn-red" onclick="javascript:location.href='/meal/' + $(this).data('id') + '/confirm'"><%= __('checkout')%></button>

          <div id="orderAlertView" class="alert alert-danger hide" style="margin-top: 10px;"></div>

          <div style="max-height: 200px;overflow: -moz-scrollbars-vertical;overflow: auto;">
            <table id="confirm-order" class="table text-grey" style="margin-top: 10px;">
              <thead class="text-left">
              <tr><td><b><%= __('meal-orders')%></b></td></tr>
              </thead>
              <tbody class="text-left">
              <%
                if(!orders){%>
              <tr><td><%= __('meal-orders-login-can-see')%></td></tr>
              <%
              }else if(orders && orders.length > 0){
                  var index = 1;
                  orders.forEach(function(order){%>
                    <tr><td><%= index%>. <%= __('user')%>
                    <%
                      Object.keys(order.orders).forEach(function(dishId){
                      meal.dishes.forEach(function(dish){
                        if(dish.id == dishId){
                          var amount = order.orders[dishId].number;
                          if(amount>0){
                    %>
                      <%= dish.title%>(<%= amount%>)
                    <%index++;
                    }}});})})}else{ %>
                          <tr><td><%= __('meal-no-orders')%></td></tr>
              <%}%>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
    <h1></h1>
  </div>
</div>

<script>
  var mealSelectionView = new MealSelectionView({ el : $("#meal-detail-container"), model : new Meal()});
  var coverDishId = $("#meal-detail-container").data("cover");
  var coverDish = $("#meal-detail-container").find(".dish a[data-gallery='" + coverDishId + "']");
  var dishTitle = coverDish.data("title");
  var desc = coverDish.data("footer");
  setupWechat($("#meal-detail-container").data("coverstring"),$("#meal-detail-container").data("title"), dishTitle + ":" + desc);
</script>

<script src="/js/jweixin-1.0.0.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwSdr10kQ9xkogbE34AyzwspjaifpaFzA&callback=mealSelectionView.initMap" async defer></script>
